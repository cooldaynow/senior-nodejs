# Libuv –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Ç–æ–∫–∞–º–∏

## –í–≤–µ–¥–µ–Ω–∏–µ

Node.js –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–æ–∑–¥–∞–≤–∞–ª—Å—è –∫–∞–∫ –æ–¥–Ω–æ–ø–æ—Ç–æ—á–Ω—ã–π runtime –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º –∫–æ–¥–æ–º. –û–¥–Ω–∞–∫–æ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ—ë–º–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π, —Ç–∞–∫–∏—Ö –∫–∞–∫ —Ñ–∞–π–ª–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å–∂–∞—Ç–∏–µ –¥–∞–Ω–Ω—ã—Ö, –æ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **libuv** ‚Äì –±–∏–±–ª–∏–æ—Ç–µ–∫—É, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç Event Loop –∏ Thread Pool. –í —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ –º—ã —Ä–∞–∑–±–µ—Ä—ë–º, –∫–∞–∫ libuv —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ—Ç–æ–∫–∞–º–∏, –≤ –∫–∞–∫–∏—Ö —Å–ª—É—á–∞—è—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Thread Pool, –∞ —Ç–∞–∫–∂–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ CPU-bound –∑–∞–¥–∞—á.

---

## 1. –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ I/O –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ libuv

- **Event Loop (–≥–ª–∞–≤–Ω—ã–π –ø–æ—Ç–æ–∫ Node.js)** —É–ø—Ä–∞–≤–ª—è–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º–∏ –∑–∞–¥–∞—á–∞–º–∏ –∏ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –≤—ã—á–∏—Å–ª–µ–Ω–∏—è.
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ I/O-–æ–ø–µ—Ä–∞—Ü–∏–∏ (`fs.readFile`, `http.request`, `net.Socket`) **–Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç Thread Pool** ‚Äì –æ–Ω–∏ –¥–µ–ª–µ–≥–∏—Ä—É—é—Ç—Å—è **—è–¥—Ä—É –û–°**.
- `setImmediate()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ I/O, –æ–Ω **–≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è —Ä–∞–Ω—å—à–µ `setTimeout(0)`**.
- üìÇ **–ü—Ä–∏–º–µ—Ä:** [io_vs_threadpool.ts](./io_vs_threadpool.ts)

---

## 2. Thread Pool –¥–ª—è I/O-bound –∑–∞–¥–∞—á

**Thread Pool (4 –ø–æ—Ç–æ–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, `UV_THREADPOOL_SIZE`)** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:

- **–§–∞–π–ª–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (`fs.readFile`, `fs.writeFile`)**
- **–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è (`crypto.pbkdf2`, `crypto.scrypt`)**
- **DNS-–∑–∞–ø—Ä–æ—Å–æ–≤ (`dns.lookup`, –Ω–æ –Ω–µ `dns.resolve`)**
- **–°–∂–∞—Ç–∏—è –¥–∞–Ω–Ω—ã—Ö (`zlib.gzip`, `zlib.deflate`)**

–ï—Å–ª–∏ –∑–∞–¥–∞—á –±–æ–ª—å—à–µ, —á–µ–º –ø–æ—Ç–æ–∫–æ–≤, –æ–Ω–∏ **–∂–¥—É—Ç –≤ –æ—á–µ—Ä–µ–¥–∏**.  
–ü–æ—Ç–æ–∫–∏ **—Ä–∞–∑–≥—Ä—É–∂–∞—é—Ç Event Loop**, –≤—ã–ø–æ–ª–Ω—è—è –±–ª–æ–∫–∏—Ä—É—é—â–∏–µ –∑–∞–¥–∞—á–∏ **–≤ —Ñ–æ–Ω–µ**.

üìÇ **–ü—Ä–∏–º–µ—Ä:** [io_vs_threadpool.ts](./io_vs_threadpool.ts)

---

## 3. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø—Ä–∏ CPU-bound –Ω–∞–≥—Ä—É–∑–∫–∞—Ö

- Thread Pool **–Ω–µ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É CPU-bound –∑–∞–¥–∞—á** ‚Äì –µ—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ –∑–∞–Ω—è—Ç, Node.js **–Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã**.
- **–ü—Ä–∏–º–µ—Ä CPU-bound –∫–æ–¥–∞ (–±–ª–æ–∫–∏—Ä—É–µ—Ç Event Loop):**

```js
for (let i = 0; i < 1e9; i++) sum += i; // –ë–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ—Ç–æ–∫!
```

- **–†–µ—à–µ–Ω–∏–µ**: –ø–µ—Ä–µ–Ω–æ—Å –≤—ã—á–∏—Å–ª–µ–Ω–∏–π –≤ **Worker Threads** –∏–ª–∏ `child_process.fork()`.
- Worker Threads **—Å–æ–∑–¥–∞—é—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–π V8 –∏ Event Loop** ‚Üí –ø–æ–¥—Ö–æ–¥—è—Ç –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π.
- **Thread Pool vs Worker Threads**:
  - `crypto`, `fs`, `zlib` ‚Üí **Thread Pool**.
  - –°–ª–æ–∂–Ω—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è (—Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥, ML) ‚Üí **Worker Threads**.

üìÇ **–ü—Ä–∏–º–µ—Ä:** [eventloop_block.ts](./eventloop_block.ts)

---

## 4. –û—à–∏–±–∫–∏ –∏ –ø–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏

‚ùå **–û—à–∏–±–∫–∞: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `setTimeout(0)` –≤–º–µ—Å—Ç–æ `setImmediate()`**

```js
setTimeout(() => console.log('setTimeout 0'), 0);
setImmediate(() => console.log('setImmediate'));
```

‚úÖ **–í—ã–≤–æ–¥:** –ï—Å–ª–∏ –µ—Å—Ç—å I/O, `setImmediate()` –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è **—Ä–∞–Ω—å—à–µ** `setTimeout(0)`.

‚ùå **–û—à–∏–±–∫–∞: –°–æ–∑–¥–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–≥–æ `UV_THREADPOOL_SIZE`**

```sh
UV_THREADPOOL_SIZE=100 node script.js
```

‚úÖ **–í—ã–≤–æ–¥:** –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–æ–≤ –º–æ–≥—É—Ç **–∑–∞–º–µ–¥–ª–∏—Ç—å —Ä–∞–±–æ—Ç—É** –∏–∑-–∑–∞ –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤.

---

## 5. –ö–∞–∫ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ—Ç–æ–∫–∞–º–∏?

‚úÖ –£–≤–µ–ª–∏—á–∏—Ç—å `UV_THREADPOOL_SIZE`, –µ—Å–ª–∏ –º–Ω–æ–≥–æ I/O-bound –∑–∞–¥–∞—á.  
‚úÖ –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ CPU-–∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ –≤ **Worker Threads**.  
‚úÖ –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á–∏ –º–µ–∂–¥—É **Event Loop, Thread Pool –∏ Worker Threads**.  
‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ offloading (–Ω–∞–ø—Ä–∏–º–µ—Ä, Redis, CDN, Nginx).

üìÇ **–ü—Ä–∏–º–µ—Ä:** [worker.ts](./worker.ts)

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

- **–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Event Loop?** –î–ª—è –æ–±—ã—á–Ω—ã—Ö –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á (—Å–µ—Ç–µ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã, —Ñ–∞–π–ª—ã, —Ç–∞–π–º–µ—Ä—ã).
- **–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Thread Pool?** –ö–æ–≥–¥–∞ –∑–∞–¥–∞—á–∏ —Ç—Ä–µ–±—É—é—Ç —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è, —Å–∂–∞—Ç–∏—è –∏–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏–π —Å —Ñ–∞–π–ª–∞–º–∏.
- **–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Worker Threads?** –ö–æ–≥–¥–∞ –µ—Å—Ç—å **—Ç—è–∂—ë–ª—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è**, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å I/O.
- **–ö–æ–≥–¥–∞ –ª—É—á—à–µ –≤—ã–Ω–µ—Å—Ç–∏ —Ä–∞—Å—á—ë—Ç—ã –≤ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å?** –ï—Å–ª–∏ –Ω–∞–≥—Ä—É–∑–∫–∞ –≤—ã—Å–æ–∫–∞—è, –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä.
